name: Browser Windows VM

on:
  workflow_dispatch:

jobs:
  browser-windows-vm:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          
          netsh advfirewall firewall delete rule name="RDP-Web" -ErrorAction SilentlyContinue
          netsh advfirewall firewall add rule name="RDP-Web" `
            dir=in action=allow protocol=TCP localport=3389
          
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | % {[char]$_})
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "WebUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "WebUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "WebUser"
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install Node.js and Dependencies
        run: |
          choco install nodejs -y
          refreshenv
          npm install -g localtunnel

      - name: Setup HTML5 RDP Client
        run: |
          $webDir = "C:\rdp-web"
          New-Item -Path $webDir -ItemType Directory -Force
          
          $html = '<html><head><title>Windows VM Access</title><style>body{margin:0;padding:20px;font-family:Arial,sans-serif;background:#1a1a1a;color:white}.container{max-width:800px;margin:0 auto;background:#2d2d2d;padding:30px;border-radius:10px}h1{color:#4CAF50}.info-box{background:#1a1a1a;padding:15px;border-radius:5px;margin:20px 0;border-left:4px solid #4CAF50}.credential{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #444}.label{font-weight:bold;color:#4CAF50}.value{font-family:monospace;background:#000;padding:4px 8px;border-radius:3px}button{background:#4CAF50;color:white;border:none;padding:12px 24px;border-radius:5px;cursor:pointer;font-size:16px;margin-top:20px}button:hover{background:#45a049}</style></head><body><div class="container"><h1>Windows VM - Remote Access</h1><div class="info-box"><h3>Connection Details</h3><div class="credential"><span class="label">Username:</span><span class="value">WebUser</span></div><div class="credential"><span class="label">Password:</span><span class="value" id="password">Check GitHub Logs</span></div><div class="credential"><span class="label">VM Address:</span><span class="value">localhost:3389</span></div></div><div style="background:#1a1a1a;padding:15px;border-radius:5px;margin-top:20px"><h3>How to Connect</h3><p><strong>Option 1: Download RDP File</strong></p><ol><li>Click the button below</li><li>Open the .rdp file with Remote Desktop</li><li>Enter the password from GitHub logs</li></ol><button onclick="downloadRDP()">Download RDP File</button><p style="margin-top:30px"><strong>Option 2: Manual Connection</strong></p><ol><li>Open Remote Desktop Connection</li><li>Connect to localhost:3389</li><li>Use credentials shown above</li></ol></div></div><script>function downloadRDP(){const rdp="full address:s:localhost:3389\nusername:s:WebUser\n";const blob=new Blob([rdp],{type:"application/x-rdp"});const url=window.URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="windows-vm.rdp";document.body.appendChild(a);a.click();document.body.removeChild(a);window.URL.revokeObjectURL(url);}</script></body></html>'
          
          $html | Out-File -FilePath "$webDir\index.html" -Encoding utf8

      - name: Start Simple Web Server
        run: |
          # Start a simple HTTP server using Python (comes with Windows runner)
          Start-Process python -ArgumentList "-m", "http.server", "8080", "-d", "C:\rdp-web" -NoNewWindow
          Start-Sleep -Seconds 5

      - name: Create Cloudflare Tunnel
        run: |
          # Download Cloudflare Tunnel (cloudflared)
          $cloudflaredUrl = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          Invoke-WebRequest -Uri $cloudflaredUrl -OutFile "C:\Windows\System32\cloudflared.exe"
          
          # Start tunnel for web interface
          Start-Process cloudflared -ArgumentList "tunnel", "--url", "http://localhost:8080" `
            -RedirectStandardOutput "C:\cloudflared.log" -NoNewWindow
          
          Start-Sleep -Seconds 15
          
          # Get the public URL from logs
          $logContent = Get-Content "C:\cloudflared.log" -Raw
          if ($logContent -match 'https://[a-zA-Z0-9-]+\.trycloudflare\.com') {
              $publicUrl = $matches[0]
              echo "PUBLIC_URL=$publicUrl" >> $env:GITHUB_ENV
              Write-Host "Public URL: $publicUrl"
          } else {
              Write-Error "Failed to get Cloudflare URL"
              Write-Host "Log content: $logContent"
              exit 1
          }

      - name: Display Access Information
        run: |
          Write-Host "`n================================================"
          Write-Host "üåê BROWSER-BASED WINDOWS VM ACCESS"
          Write-Host "================================================"
          Write-Host ""
          Write-Host "üîó Web Interface: $env:PUBLIC_URL"
          Write-Host ""
          Write-Host "üìù Credentials:"
          Write-Host "   Username: WebUser"
          Write-Host "   Password: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "üí° Instructions:"
          Write-Host "   1. Open the Web Interface URL in your browser"
          Write-Host "   2. Download the RDP configuration file"
          Write-Host "   3. Open it with Remote Desktop Connection"
          Write-Host "   4. Use the credentials shown above"
          Write-Host ""
          Write-Host "‚ö†Ô∏è  Note: Cloudflare free tunnels expire after a few hours"
          Write-Host "          Refresh the workflow if the link stops working"
          Write-Host ""
          Write-Host "================================================`n"

      - name: Keep Alive
        run: |
          while ($true) {
              Write-Host "[$(Get-Date)] VM Active - Access via: $env:PUBLIC_URL"
              Write-Host "           Password: $env:RDP_PASSWORD"
              Start-Sleep -Seconds 300
          }
