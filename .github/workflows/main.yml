name: RDP-noVNC (Fixed)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install noVNC and Dependencies
        run: |
          choco install ultravnc ngrok python -y
          python -m pip install websockify
          mkdir C:\noVNC
          git clone https://github.com/novnc/noVNC.git C:\noVNC

      - name: Configure UltraVNC Server
        run: |
          $vncPath = "C:\Program Files\uvnc bvba\UltraVNC"
          net stop uvnc_service
          & "$vncPath\winvnc.exe" -install
          # UltraVNC requires a service restart to apply default settings
          net start uvnc_service

      - name: Setup Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          # Use Start-Process so ngrok runs in the background
          Start-Process -FilePath "ngrok.exe" -ArgumentList "http 6080" -NoNewWindow

      - name: Start Websockify Bridge
        run: |
          Start-Process -FilePath "python.exe" -ArgumentList "-m websockify --web C:\noVNC 6080 localhost:5900" -NoNewWindow

      - name: Get Public URL (Fixed Loop)
        run: |
          Write-Host "Waiting for Ngrok tunnel to initialize..."
          $MaxRetries = 20
          $RetryCount = 0
          $url = $null

          while (-not $url -and $RetryCount -lt $MaxRetries) {
            try {
              $response = curl.exe -s http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
              if ($response.tunnels.Count -gt 0) {
                $url = $response.tunnels[0].public_url
              }
            } catch {
              # API might not be up yet
            }
            if (-not $url) {
              Start-Sleep -Seconds 5
              $RetryCount++
              Write-Host "Retrying... ($RetryCount/$MaxRetries)"
            }
          }

          if ($url) {
            Write-Host "`n=========================================="
            Write-Host "ACCESS YOUR WINDOWS HERE:"
            Write-Host "$url/vnc.html?autoconnect=true"
            Write-Host "VNC Password: (Check UltraVNC defaults or leave blank)"
            Write-Host "==========================================`n"
          } else {
            Write-Error "Ngrok failed to provide a URL after $MaxRetries attempts."
            exit 1
          }

      - name: Keep Alive
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] noVNC Session Active..."
            Start-Sleep -Seconds 300
          }
