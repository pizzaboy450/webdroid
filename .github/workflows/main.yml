name: RDP
on:
  workflow_dispatch:

jobs:
  windows-online:
    runs-on: windows-latest
    steps:
      - name: Enable Windows RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          net user runneradmin CloudPass2025!

      - name: Start Online Bridge
        shell: bash
        run: |
          # Install tmate via pacman (built into the runner's git-bash)
          pacman -Sy tmate --noconfirm
          
          # Start a tmate session that tunnels the RDP Port (3389)
          # This creates a web-accessible terminal AND a relay
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait-for-connection
          
          # Print the URLs
          echo "------------------------------------------------------------"
          tmate -S /tmp/tmate.sock display -p "WEB TERMINAL: #{tmate_web}"
          tmate -S /tmp/tmate.sock display -p "SSH RELAY: #{tmate_ssh}"
          echo "------------------------------------------------------------"
          echo "To connect to Desktop: Use the SSH RELAY in an RDP client"
          echo "or use the WEB TERMINAL to run apps directly."
          echo "------------------------------------------------------------"
          
          # Keep the runner alive
          while true; do sleep 300; done
