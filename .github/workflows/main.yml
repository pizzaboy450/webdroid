name: Guacamole-Localtunnel-With-Password
on:
  workflow_dispatch:

jobs:
  browser-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Setup Windows RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          $password = "Password123!"
          $user = [adsi]"WinNT://localhost/runneradmin,user"
          $user.SetPassword($password)

      - name: Install Guac-Bridge & Localtunnel
        run: |
          npm install -g guacamole-lite localtunnel
          $guacScript = @"
          const GuacamoleLite = require('guacamole-lite');
          const guacServer = new GuacamoleLite(
              { port: 8080 },
              { host: '127.0.0.1', port: 3389 },
              { encryption: 'none' }
          );
          "@
          $guacScript | Out-File -FilePath "guac.js"

      - name: Start Bridge and Tunnel
        shell: pwsh
        run: |
          # 1. Get the Password (IP Address)
          $publicIP = (Invoke-WebRequest -Uri "https://ipv4.icanhazip.com").Content.Trim()
          
          # 2. Start the Guacamole Web Bridge
          Start-Process node -ArgumentList "guac.js" -NoNewWindow
          
          Write-Host "Starting Localtunnel..."
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c lt --port 8080 > lt.log" -NoNewWindow
          
          Write-Host "Waiting for Link..."
          $url = $null
          for ($i=1; $i -le 20; $i++) {
              Start-Sleep -Seconds 5
              if (Test-Path "lt.log") {
                  $content = Get-Content "lt.log"
                  $match = $content | Select-String -Pattern "https://.*\.loca\.lt"
                  if ($match) {
                      $url = $match.Matches.Value.Trim()
                      Write-Host "=========================================="
                      Write-Host "TUNNEL PASSWORD (IP): ${publicIP}"
                      Write-Host "LINK: ${url}"
                      Write-Host "------------------------------------------"
                      Write-Host "RDP User: runneradmin"
                      Write-Host "RDP Pass: Password123!"
                      Write-Host "=========================================="
                      break
                  }
              }
              Write-Host "Attempt ${i} ... waiting for tunnel"
          }
          if (-not $url) { throw "Tunnel failed." }

      - name: Keep Alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active..."
          }
