name: Persistent Android Stream
on:
  workflow_dispatch: # Allows manual start
  schedule:
    - cron: '0 */5 * * *' # Backup trigger every 5 hours

jobs:
  stream:
    runs-on: ubuntu-latest # NOTE: Standard runners lack KVM; use 'larger' for speed
    steps:
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger

      - name: Launch Android & Streamer
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          # 1. Setup Docker with Redroid (Android 11) and noVNC
          docker run -d -p 6080:80 --privileged redroid/redroid:11.0.0-latest
          
          # 2. Setup Tunnel (Using Pinggy as it's easier for quick CLI)
          ssh -o StrictHostKeyChecking=no -R 80:localhost:6080 a.pinggy.io &
          
          # 3. Wait and keep alive for 5.5 hours
          sleep 19800 

      - name: Auto-Restart Workflow
        if: always()
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GH_PAT }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/android-stream.yml/dispatches \
          -d '{"ref":"main"}'
