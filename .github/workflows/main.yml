name: Windows HD Stream (Unbreakable)
on: 
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream_desktop:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}

      - name: Install Tools
        run: |
          choco install obs-studio ffmpeg vb-cable -y --skip-already-installed
        shell: powershell

      - name: Setup HLS and OBS
        shell: powershell
        run: |
          # 1. Create a clean folder for video files
          if (Test-Path "stream") { Remove-Item -Recurse -Force "stream" }
          New-Item -ItemType Directory -Path "stream" -Force

          # 2. Configure OBS to save HLS files directly to the 'stream' folder
          $obsSettingsDir = "$env:APPDATA\obs-studio\basic\profiles\Untitled"
          if (!(Test-Path $obsSettingsDir)) { New-Item -ItemType Directory -Path $obsSettingsDir -Force }
          
          # We tell OBS to use standard recording/output to our folder
          $serviceJson = '{"settings":{"key":"","server":""},"type":"rtmp_custom"}'
          Set-Content -Path "$obsSettingsDir\service.json" -Value $serviceJson
          Write-Host "OBS Folders Prepared."

      - name: Start OBS Studio
        shell: powershell
        run: |
          # Launch OBS
          Start-Process "C:\Program Files\obs-studio\bin\64bit\obs64.exe" -ArgumentList "--startstreaming"
          Start-Sleep -Seconds 15

      - name: Sync Stream to GitHub (The "Tunnel" Replacement)
        shell: powershell
        run: |
          git config --global user.name "StreamBot"
          git config --global user.email "bot@github.com"
          
          Write-Host "Starting sync loop... Video will be available on your GitHub Pages URL."
          
          # This loop pushes the video files to your repo every 20 seconds
          $timer = [diagnostics.stopwatch]::StartNew()
          while ($timer.Elapsed.TotalSeconds -lt 19800) {
              git add stream/*.m3u8 stream/*.ts
              git commit -m "Update Stream [skip ci]"
              git push origin main
              Write-Host "Video Chunk Pushed."
              Start-Sleep -Seconds 20
          }
