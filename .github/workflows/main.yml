name: Windows HD Stream (Final Fix)
on: 
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream_desktop:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}

      - name: Install FFmpeg
        run: choco install ffmpeg -y
        shell: powershell

      - name: Start Streaming
        shell: powershell
        run: |
          # 1. Create the folder
          if (!(Test-Path "live")) { New-Item -ItemType Directory -Path "live" }
          
          # 2. Start FFmpeg in the background to capture screen
          # This captures the desktop and saves it as HLS segments
          Start-Process ffmpeg -ArgumentList "-f gdigrab -framerate 30 -i desktop -c:v libx264 -preset ultrafast -tune zerolatency -g 60 -hls_time 2 -hls_list_size 5 -hls_flags delete_segments -f hls live/live.m3u8" -NoNewWindow

          # 3. Give it a head start to create the first file
          Start-Sleep -Seconds 10

          # 4. The Sync Loop
          git config --global user.name "StreamBot"
          git config --global user.email "bot@github.com"
          
          $timer = [diagnostics.stopwatch]::StartNew()
          while ($timer.Elapsed.TotalSeconds -lt 19800) {
              # Check if files exist before adding
              if (Test-Path "live/live.m3u8") {
                  git add live/*.m3u8 live/*.ts
                  git commit -m "Stream Update [skip ci]" --allow-empty
                  git push origin main
                  Write-Host "Video Pushed Successfully."
              } else {
                  Write-Host "Waiting for FFmpeg to generate files..."
              }
              Start-Sleep -Seconds 15
          }
