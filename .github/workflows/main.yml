name: RDP-noVNC (Final Fixed)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install noVNC and Dependencies
        run: |
          choco install ultravnc ngrok python -y
          python -m pip install websockify
          mkdir C:\noVNC
          git clone https://github.com/novnc/noVNC.git C:\noVNC

      - name: Start UltraVNC Server (Process Mode)
        run: |
          $vncPath = "C:\Program Files\uvnc bvba\UltraVNC"
          
          # Kill any existing instances
          stop-process -name winvnc -ErrorAction SilentlyContinue
          
          # Set VNC password to 'password' in the registry
          # UltraVNC uses a hex-encoded binary key for the password
          $regPath = "HKLM:\SOFTWARE\UltraVNC\Default"
          if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
          New-ItemProperty -Path $regPath -Name "Password" -Value ([byte[]](0x5E,0x2B,0xD3,0x64,0x90,0x6F,0x8F,0x00)) -PropertyType Binary -Force
          
          # Start winvnc as a background process instead of a service
          Start-Process -FilePath "$vncPath\winvnc.exe" -ArgumentList "-run" -NoNewWindow

      - name: Setup Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process -FilePath "ngrok.exe" -ArgumentList "http 6080" -NoNewWindow

      - name: Start Websockify Bridge
        run: |
          # Bridge local VNC (5900) to noVNC Web (6080)
          Start-Process -FilePath "python.exe" -ArgumentList "-m websockify --web C:\noVNC 6080 localhost:5900" -NoNewWindow

      - name: Get Public URL
        run: |
          Write-Host "Waiting for Ngrok..."
          $MaxRetries = 20
          for ($i=0; $i -lt $MaxRetries; $i++) {
            try {
              $tunnels = curl.exe -s http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
              if ($tunnels.tunnels.Count -gt 0) {
                $url = $tunnels.tunnels[0].public_url
                Write-Host "=========================================="
                Write-Host "ACCESS YOUR WINDOWS HERE:"
                Write-Host "$url/vnc.html?autoconnect=true"
                Write-Host "VNC Password: password"
                Write-Host "=========================================="
                return
              }
            } catch {}
            Start-Sleep -Seconds 5
          }
          throw "Ngrok failed to start."

      - name: Maintain Connection
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] noVNC Session Active..."
            Start-Sleep -Seconds 300
          }
