name: Windows HD Stream (Auto-Repeat)
on: 
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream_desktop:
    runs-on: windows-latest
    steps:
      - name: Install Tools & Virtual Audio
        run: |
          choco install nginx obs-studio ffmpeg ngrok screencapturererecorder -y --no-progress
        shell: powershell

      - name: Configure Nginx
        shell: powershell
        run: |
          $nginxConfPath = "C:\tools\nginx-1.24.0\conf\nginx.conf" # Standard Choco path
          if (!(Test-Path "C:\temp\hls")) { New-Item -ItemType Directory -Path "C:\temp\hls" -Force }
          $conf = @"
          worker_processes 1;
          events { worker_connections 1024; }
          rtmp {
              server {
                  listen 1935;
                  application live {
                      live on;
                      hls on;
                      hls_path C:/temp/hls;
                      hls_fragment 3s;
                  }
              }
          }
          http {
              server {
                  listen 80;
                  location /hls {
                      root C:/temp;
                      add_header Access-Control-Allow-Origin *;
                  }
              }
          }
          "@
          Set-Content -Path $nginxConfPath -Value $conf

      - name: Start Nginx
        shell: powershell
        run: |
          $nginxPath = (Get-ChildItem -Path C:\ -Filter nginx.exe -Recurse | Select-Object -First 1).FullName
          cd (Split-Path $nginxPath)
          Start-Process .\nginx.exe

      - name: Start Ngrok & Get URL
        shell: powershell
        id: ngrok_step
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process ngrok -ArgumentList "http 80" -NoNewWindow
          Start-Sleep -Seconds 10
          $url = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels[0].public_url
          Write-Host "STREAM URL: $url/hls/live.m3u8"

      - name: Start OBS Studio
        shell: powershell
        run: |
          Start-Process "C:\Program Files\obs-studio\bin\64bit\obs64.exe" -ArgumentList "--startstreaming"

      - name: Run for 5.5 Hours
        shell: powershell
        run: Start-Sleep -Seconds 19800 # 5.5 hours

      - name: Trigger Next Run
        if: always()
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.MY_GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/dispatches \
          -d '{"event_type": "restart_stream"}'
