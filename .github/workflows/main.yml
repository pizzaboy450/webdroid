name: Run SickCodes Android VM
on: 
  workflow_dispatch: # Allows you to run it manually with one click

jobs:
  launch-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Enable KVM Hardware Acceleration
        run: |
          # Crucial for performance; allows the VM to use the host CPU
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Launch SickCodes Dock-Droid
        run: |
          # This pulls the BlissOS (Android x86) image
          # We run it headlessly and expose ADB (5555) and VNC (5999)
          docker run -d \
            --name android-vm \
            --device /dev/kvm \
            -p 5555:5555 \
            -p 5900:5999 \
            -e EXTRA="-display none -vnc 0.0.0.0:99,password=off" \
            sickcodes/dock-droid:latest

      - name: Wait for Android to Boot
        run: |
          echo "Waiting for Android to initialize..."
          # Give it about 2 minutes to boot into the system
          sleep 120
          
      - name: Install VMOS Cloud APK
        run: |
          # Install ADB to talk to the container
          sudo apt-get install -y adb
          adb connect localhost:5555
          
          # Download your VMOS APK (Replace with your actual link)
          wget -O vmos.apk "https://example.com/path-to-vmos-cloud.apk"
          
          # Push and install
          adb install vmos.apk
          echo "VMOS Cloud installed successfully."

      - name: Keep Alive (Optional)
        run: |
          # Keeps the workflow running for 1 hour so you can use it
          echo "VM is running. You can use 'ssh -L 5900:localhost:5900' if you had a tunnel."
          sleep 3600
