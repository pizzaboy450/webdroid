name: Windows noVNC (Auto-Restart Persistent)

on:
  schedule:
    - cron: "0 */6 * * *"  # runs every 6 hours
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Install QEMU and Ngrok
        run: |
          choco install qemu ngrok -y
          pip install websockify # Needed for noVNC to work

      - name: Prepare VM directory
        run: |
          mkdir C:\VM
          # Download noVNC interface files
          git clone https://github.com/novnc/noVNC.git C:\VM\noVNC

      - name: Download Windows Image
        run: |
          # Downloading a pre-installed Tiny10 (Light Windows 10) disk
          # If this link expires, replace with your own direct QCOW2/VHDX link
          curl -L -o C:\VM\win.qcow2 "https://app.vagrantup.com/mikesheely/boxes/windows-10-64/versions/1.0.0/providers/qemu.box"

      - name: Setup Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          # Tunneling port 6080 (noVNC port)
          Start-Process -FilePath "ngrok.exe" -ArgumentList "http 6080" -NoNewWindow

      - name: Start Windows VM and noVNC
        run: |
          $qemuPath = "C:\Program Files\qemu"
          $env:Path += ";$qemuPath"
          
          # 1. Start QEMU in the background
          # -vnc :0 opens VNC on port 5900
          Start-Process -FilePath "qemu-system-x86_64.exe" -ArgumentList `
            "-m 4G -smp 2 -cpu qemu64 -drive file=C:\VM\win.qcow2,format=qcow2 -net nic -net user -vnc :0 -usb -device usb-tablet" `
            -NoNewWindow

          # 2. Start Websockify to bridge VNC (5900) to noVNC Web (6080)
          Start-Process -FilePath "python.exe" -ArgumentList `
            "-m websockify --web C:\VM\noVNC 6080 localhost:5900" `
            -NoNewWindow
          
          Write-Host "Wait 30 seconds for Ngrok to initialize..."
          Start-Sleep -Seconds 30

      - name: Output Connection URL
        run: |
          $tunnels = curl.exe -s http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
          $url = $tunnels.tunnels[0].public_url
          Write-Host "=========================================="
          Write-Host "ACCESS WINDOWS HERE:"
          Write-Host "$url/vnc.html?autoconnect=true"
          Write-Host "=========================================="

      - name: Keep Alive
        run: |
          Write-Host "VM is active. Session will run for 6 hours."
          Start-Sleep -Seconds 21000
