name: RDP
on:
  workflow_dispatch:
    inputs:
      ngrok_auth:
        description: 'Ngrok Auth Token'
        required: true

jobs:
  run-rdp:
    runs-on: windows-latest
    steps:
      - name: Setup Web Desktop
        run: |
          choco install tightvnc ngrok -y
          & "C:\Program Files\TightVNC\tvnserver.exe" -install
          & "C:\Program Files\TightVNC\tvnserver.exe" -controlapp -setpassword "cloud123"
          net start "TightVNC Server"
          npm install -g novnc

      - name: Start Bridge and Tunnel
        shell: pwsh
        run: |
          # 1. Set Ngrok Token
          ngrok config add-authtoken "${{ github.event.inputs.ngrok_auth }}"
          
          # 2. Start noVNC bridge in background
          Start-Process powershell -ArgumentList "-NoProfile -Command & {novnc --vnc localhost:5900 --listen 8080}"
          
          # 3. Wait for port 8080 to be active (Fixes 502/503 errors)
          Write-Host "Waiting for Web Desktop..."
          while (!(Test-NetConnection localhost -Port 8080).TcpTestSucceeded) { Start-Sleep -Seconds 2 }
          
          # 4. Start Ngrok
          Write-Host "âœ… Desktop is ready! Launching Tunnel..."
          ngrok http 8080 --log=stdout
