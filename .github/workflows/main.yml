name: Guac-Serveo-Direct
on:
  workflow_dispatch:

jobs:
  browser-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Setup Windows RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          $password = "Password123!"
          $user = [adsi]"WinNT://localhost/runneradmin,user"
          $user.SetPassword($password)

      - name: Install Guac-Bridge
        run: |
          npm install -g guacamole-lite
          $guacScript = @"
          const GuacamoleLite = require('guacamole-lite');
          const guacServer = new GuacamoleLite(
              { port: 8080 },
              { host: '127.0.0.1', port: 3389 },
              { encryption: 'none' }
          );
          "@
          $guacScript | Out-File -FilePath "guac.js"

      - name: Start Bridge and Tunnel
        shell: pwsh
        run: |
          # Start Guacamole
          Start-Process node -ArgumentList "guac.js" -NoNewWindow
          
          Write-Host "Connecting to Tunnel..."
          # Connect to Serveo with a manual retry loop
          $max_retries = 5
          for ($i=1; $i -le $max_retries; $i++) {
              Start-Process ssh -ArgumentList "-o StrictHostKeyChecking=no -R 80:127.0.0.1:8080 serveo.net" -NoNewWindow -RedirectStandardOutput "tunnel.log"
              Start-Sleep -Seconds 15
              $url = (Get-Content "tunnel.log" -ErrorAction SilentlyContinue | Select-String -Pattern "https://[a-zA-Z0-9.-]+").Matches.Value
              if ($url) {
                  Write-Host "=========================================="
                  Write-Host "LINK FOUND: $url"
                  Write-Host "User: runneradmin"
                  Write-Host "Pass: Password123!"
                  Write-Host "=========================================="
                  break
              }
              Write-Host "Retry $i: Tunnel didn't give a URL yet..."
          }

      - name: Keep Alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active..."
          }
