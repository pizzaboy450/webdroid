name: Windows HD Stream (Ultimate)
on: 
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream_desktop:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          choco install nginx obs-studio ffmpeg ngrok vb-cable -y --skip-already-installed
        shell: powershell

      - name: Configure and Start Nginx
        shell: powershell
        run: |
          if (!(Test-Path "C:\temp\hls")) { New-Item -ItemType Directory -Path "C:\temp\hls" -Force }
          
          # Find Nginx path
          $nginxExe = (Get-ChildItem -Path C:\tools, C:\ProgramData\chocolatey -Filter nginx.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          $nginxDir = Split-Path $nginxExe
          $confPath = Join-Path $nginxDir "conf\nginx.conf"

          $conf = @"
          worker_processes 1;
          events { worker_connections 1024; }
          rtmp {
              server {
                  listen 1935;
                  application live {
                      live on;
                      hls on;
                      hls_path C:/temp/hls;
                      hls_fragment 2s;
                  }
              }
          }
          http {
              server {
                  listen 80;
                  location /hls {
                      root C:/temp;
                      add_header Access-Control-Allow-Origin *;
                      types { application/vnd.apple.mpegurl m3u8; video/mp2t ts; }
                  }
              }
          }
          "@
          Set-Content -Path $confPath -Value $conf

          # KILL GHOST PROCESSES AND START FRESH
          taskkill /F /IM nginx.exe /T 2>$null
          cd $nginxDir
          Start-Process .\nginx.exe -WorkingDirectory $nginxDir
          
          # VERIFY NGINX IS LIVE BEFORE CONTINUING
          Start-Sleep -Seconds 5
          if (!(netstat -ano | findstr ":80")) { throw "Nginx failed to start on Port 80" }

      - name: Inject OBS Settings
        shell: powershell
        run: |
          $obsSettingsDir = "$env:APPDATA\obs-studio\basic\profiles\Untitled"
          if (!(Test-Path $obsSettingsDir)) { New-Item -ItemType Directory -Path $obsSettingsDir -Force }
          $serviceJson = '{"settings":{"key":"","server":"rtmp://127.0.0.1:1935/live"},"type":"rtmp_custom"}'
          Set-Content -Path "$obsSettingsDir\service.json" -Value $serviceJson

      - name: Start Ngrok & Save URL
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process ngrok -ArgumentList "http 80" -NoNewWindow
          Start-Sleep -Seconds 25
          
          $url = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels[0].public_url
          $streamUrl = "$url/hls/live.m3u8"
          Set-Content -Path "current_stream.txt" -Value $streamUrl
          
          git config --global user.name "StreamBot"
          git config --global user.email "bot@github.com"
          git add current_stream.txt
          $status = git status --porcelain
          if ($status) {
              git commit -m "Update Stream URL [skip ci]"
              git push
          }

      - name: Start OBS Studio
        shell: powershell
        run: |
          Start-Process "C:\Program Files\obs-studio\bin\64bit\obs64.exe" -ArgumentList "--startstreaming"

      - name: Run and Auto-Repeat
        shell: powershell
        run: |
          Write-Host "Streaming live. Auto-restart in 5.5 hours."
          $timer = [diagnostics.stopwatch]::StartNew()
          while ($timer.Elapsed.TotalSeconds -lt 19800) {
              Start-Sleep -Seconds 60
          }
          
          curl -X POST -H "Authorization: token ${{ secrets.MY_GITHUB_TOKEN }}" `
          -H "Accept: application/vnd.github.v3+json" `
          https://api.github.com/repos/${{ github.repository }}/dispatches `
          -d '{"event_type": "restart_stream"}'
