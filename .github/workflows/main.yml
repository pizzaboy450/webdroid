name: Ultimate Browser Windows (Tmate)
on:
  workflow_dispatch:

jobs:
  windows-direct:
    runs-on: windows-latest
    steps:
      - name: Setup Windows RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          # Set a password for the default runner user
          net user runneradmin CloudPass2025!

      - name: Start Tmate (Web Gateway)
        shell: cmd
        run: |
          # Download portable Tmate
          curl -L https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz -o tmate.tar.xz
          # Note: We use the Git-Bash tools already on the runner to extract and run
          tar -xf tmate.tar.xz
          
          # Start Tmate and save the web URL to a file
          # We use a unique session name to avoid conflicts
          start /b tmate -S /tmp/tmate.sock new-session -d
          timeout 5
          tmate -S /tmp/tmate.sock wait-for-connection
          tmate -S /tmp/tmate.sock display -p "#{tmate_web}" > link.txt

      - name: Display Link
        shell: pwsh
        run: |
          $url = Get-Content link.txt
          Write-Host "`n********************************************************"
          Write-Host "âœ… WINDOWS TERMINAL / BROWSER READY"
          Write-Host "********************************************************"
          Write-Host "CLICK THIS: $url"
          Write-Host "********************************************************"
          Write-Host "To see the Desktop, use a Web-RDP portal like MyRDP.net"
          Write-Host "with the IP: 127.0.0.1 (Tmate tunnels it automatically)"
          Write-Host "********************************************************"

      - name: Keep Online
        run: |
          while($true) { Start-Sleep -Seconds 300 }
