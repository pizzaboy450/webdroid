name: Windows on noVNC
on: 
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install QEMU and noVNC
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 novnc python3-websockify
          
      - name: Download Windows ISO (Tiny10/Server)
        run: |
          # Downloading a lightweight Windows image is faster. 
          # This example uses a placeholder URL; replace with a direct link to your ISO.
          curl -L -o windows.iso "https://example.com/path-to-your-windows.iso"

      - name: Create Virtual Disk
        run: qemu-img create -f qcow2 windows.qcow2 20G

      - name: Start QEMU and noVNC
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # 1. Install Ngrok
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install ngrok
          
          # 2. Authenticate Ngrok
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          
          # 3. Start noVNC proxy (converts VNC to WebSockets) on port 6080
          # We point it to localhost:5900 (default QEMU VNC port)
          websockify --web /usr/share/novnc/ 6080 localhost:5900 &
          
          # 4. Start Ngrok tunnel for the noVNC port
          ngrok http 6080 --log=stdout > /dev/null &
          
          echo "Waiting for Ngrok to generate URL..."
          sleep 10
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
          
          # 5. Launch Windows in QEMU
          # -m 4G (RAM), -smp 2 (Cores)
          qemu-system-x86_64 \
            -m 4G \
            -smp 2 \
            -drive file=windows.qcow2,format=qcow2 \
            -cdrom windows.iso \
            -vnc :0 \
            -net nic -net user \
            -accel tcg
