name: Browser Windows Native
on:
  workflow_dispatch:

jobs:
  windows-web:
    runs-on: windows-latest
    steps:
      - name: Configure Windows
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          net user runneradmin CloudPass2025!

      - name: Deploy MeshCentral Web Gateway
        shell: pwsh
        run: |
          # Install MeshCentral locally on the runner
          npm install meshcentral
          
          # This starts a "Mesh" agent that creates its own web-reachable identity
          # No tunnel software needed because it uses a Web-Socket bridge
          $MeshConfig = @{
              settings = @{
                  port = 8080
                  redirport = 80
              }
          } | ConvertTo-Json
          $MeshConfig | Out-File "meshcentral-data/config.json" -Encoding utf8
          
          Start-Process node -ArgumentList "node_modules/meshcentral" -WindowStyle Hidden

      - name: Start Tmate Web Bridge
        shell: pwsh
        run: |
          # We use Tmate ONLY to provide the browser URL (The website itself is the Windows Desktop)
          # Tmate is native to GitHub Runners and requires zero configuration
          pacman -S tmate --noconfirm
          tmate -S /tmp/tmate.sock new-session -d
          Start-Sleep -Seconds 5
          $url = tmate -S /tmp/tmate.sock display -p "#{tmate_web}"
          
          Write-Host "`n=========================================="
          Write-Host "âœ… WINDOWS BROWSER ACCESS"
          Write-Host "URL: $url"
          Write-Host "==========================================`n"
          
          while($true) { Start-Sleep -Seconds 300 }
