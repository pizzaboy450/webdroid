name: Windows HD Stream (Ultimate)
on: 
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream_desktop:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          choco install nginx obs-studio ffmpeg ngrok vb-cable -y --skip-already-installed
        shell: powershell

      - name: Configure and Start Nginx
        shell: powershell
        run: |
          if (!(Test-Path "C:\temp\hls")) { New-Item -ItemType Directory -Path "C:\temp\hls" -Force }
          $nginxExe = (Get-ChildItem -Path C:\tools, C:\ProgramData\chocolatey -Filter nginx.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          $nginxDir = Split-Path $nginxExe
          
          # Force kill any existing nginx to avoid port conflicts
          Stop-Process -Name nginx -Force -ErrorAction SilentlyContinue
          
          $conf = @"
          worker_processes 1;
          events { worker_connections 1024; }
          rtmp {
              server {
                  listen 1935;
                  application live {
                      live on;
                      hls on;
                      hls_path C:/temp/hls;
                      hls_fragment 2s;
                  }
              }
          }
          http {
              server {
                  listen 80;
                  location /hls {
                      root C:/temp;
                      add_header Access-Control-Allow-Origin *;
                      types { application/vnd.apple.mpegurl m3u8; video/mp2t ts; }
                  }
              }
          }
          "@
          Set-Content -Path "$nginxDir\conf\nginx.conf" -Value $conf

          cd $nginxDir
          Start-Process .\nginx.exe -WorkingDirectory $nginxDir
          Start-Sleep -Seconds 5

      - name: Start Ngrok & Verify Connection
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # 1. Start Ngrok
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process ngrok -ArgumentList "http 80" -NoNewWindow
          
          # 2. Wait for Ngrok API to wake up
          Write-Host "Waiting for Ngrok API..."
          Start-Sleep -Seconds 15
          
          # 3. Fetch URL with Retry Logic
          $attempts = 0
          $url = ""
          while ($attempts -lt 10 -and -not $url) {
              try {
                  $tunnels = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels
                  $url = $tunnels[0].public_url
              } catch {
                  Write-Host "Waiting for tunnel..."
                  Start-Sleep -Seconds 5
                  $attempts++
              }
          }

          if (!$url) { throw "Ngrok failed to create a tunnel!" }
          
          # 4. Save and Push URL
          $streamUrl = "$url/hls/live.m3u8"
          Write-Host "LIVE URL: $streamUrl"
          Set-Content -Path "current_stream.txt" -Value $streamUrl
          
          git config --global user.name "StreamBot"
          git config --global user.email "bot@github.com"
          git add current_stream.txt
          git commit -m "Update Stream URL [skip ci]"
          git push

      - name: Start OBS Studio
        shell: powershell
        run: |
          # Inject settings just in case
          $obsSettingsDir = "$env:APPDATA\obs-studio\basic\profiles\Untitled"
          if (!(Test-Path $obsSettingsDir)) { New-Item -ItemType Directory -Path $obsSettingsDir -Force }
          $serviceJson = '{"settings":{"key":"","server":"rtmp://127.0.0.1:1935/live"},"type":"rtmp_custom"}'
          Set-Content -Path "$obsSettingsDir\service.json" -Value $serviceJson
          
          # Start OBS
          Start-Process "C:\Program Files\obs-studio\bin\64bit\obs64.exe" -ArgumentList "--startstreaming"

      - name: Run and Auto-Repeat
        shell: powershell
        run: |
          Write-Host "STREAM ACTIVE. Check your Chrome Extension now."
          $timer = [diagnostics.stopwatch]::StartNew()
          while ($timer.Elapsed.TotalSeconds -lt 19800) { Start-Sleep -Seconds 60 }
          
          curl -X POST -H "Authorization: token ${{ secrets.MY_GITHUB_TOKEN }}" `
          -H "Accept: application/vnd.github.v3+json" `
          https://api.github.com/repos/${{ github.repository }}/dispatches `
          -d '{"event_type": "restart_stream"}'
