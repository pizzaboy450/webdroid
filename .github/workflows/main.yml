name: Windows HD Stream (Ironclad)
on: 
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream_desktop:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          choco install nginx obs-studio ffmpeg ngrok vb-cable -y --skip-already-installed
        shell: powershell

      - name: Configure and Start Nginx
        shell: powershell
        run: |
          if (!(Test-Path "C:\temp\hls")) { New-Item -ItemType Directory -Path "C:\temp\hls" -Force }
          $nginxExe = (Get-ChildItem -Path C:\tools, C:\ProgramData\chocolatey -Filter nginx.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          $nginxDir = Split-Path $nginxExe
          
          Stop-Process -Name nginx -Force -ErrorAction SilentlyContinue
          
          $conf = @"
          worker_processes 1;
          events { worker_connections 1024; }
          rtmp {
              server {
                  listen 1935;
                  application live {
                      live on;
                      hls on;
                      hls_path C:/temp/hls;
                      hls_fragment 2s;
                  }
              }
          }
          http {
              server {
                  listen 80;
                  location /hls {
                      root C:/temp;
                      add_header Access-Control-Allow-Origin *;
                      types { application/vnd.apple.mpegurl m3u8; video/mp2t ts; }
                  }
              }
          }
          "@
          Set-Content -Path "$nginxDir\conf\nginx.conf" -Value $conf

          cd $nginxDir
          Start-Process .\nginx.exe -WorkingDirectory $nginxDir
          
          # CRITICAL: Wait until Port 80 is actually open
          Write-Host "Waiting for Nginx to bind to Port 80..."
          for ($i=0; $i -lt 10; $i++) {
              if (netstat -ano | findstr ":80") { break }
              Start-Sleep -Seconds 2
          }

      - name: Start Ngrok & Verify API
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process ngrok -ArgumentList "http 80" -NoNewWindow
          Start-Sleep -Seconds 15
          
          # Get URL with fallback retries
          $url = ""
          for ($i=0; $i -lt 5; $i++) {
              try {
                  $url = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels[0].public_url
                  if ($url) { break }
              } catch { Start-Sleep -Seconds 5 }
          }

          if (!$url) { throw "Ngrok API failed to return a URL." }
          
          $streamUrl = "$url/hls/live.m3u8"
          Set-Content -Path "current_stream.txt" -Value $streamUrl
          
          git config --global user.name "StreamBot"
          git config --global user.email "bot@github.com"
          git add current_stream.txt
          git commit -m "Update Stream URL [skip ci]" || Write-Host "No changes"
          git push

      - name: Start OBS Studio (Force Settings)
        shell: powershell
        run: |
          $obsSettingsDir = "$env:APPDATA\obs-studio\basic\profiles\Untitled"
          if (!(Test-Path $obsSettingsDir)) { New-Item -ItemType Directory -Path $obsSettingsDir -Force }
          $serviceJson = '{"settings":{"key":"","server":"rtmp://127.0.0.1:1935/live"},"type":"rtmp_custom"}'
          Set-Content -Path "$obsSettingsDir\service.json" -Value $serviceJson
          
          Start-Process "C:\Program Files\obs-studio\bin\64bit\obs64.exe" -ArgumentList "--startstreaming", "--minimize-to-tray"

      - name: Keep-Alive Loop
        shell: powershell
        run: |
          Write-Host "SUCCESS: The stream is now live and stable."
          $timer = [diagnostics.stopwatch]::StartNew()
          while ($timer.Elapsed.TotalSeconds -lt 19800) { Start-Sleep -Seconds 60 }
          
          curl -X POST -H "Authorization: token ${{ secrets.MY_GITHUB_TOKEN }}" `
          -H "Accept: application/vnd.github.v3+json" `
          https://api.github.com/repos/${{ github.repository }}/dispatches `
          -d '{"event_type": "restart_stream"}'
