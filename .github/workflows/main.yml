- name: Start Cloudflare Tunnel & Update Gist
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GIST_ID: "a4b55baae4fc0ffc6f8b9e6ee7f12d75"
        run: |
          # 1. Install Cloudflare
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared

          # 2. HEALTH CHECK: Wait for the local web server to be reachable
          echo "Waiting for local web server on port 6080..."
          timeout 60s bash -c 'until curl -s localhost:6080 > /dev/null; do sleep 2; done' || exit 1

          # 3. Start Tunnel with a specific 'Heartbeat' setting
          ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate --http2-origin > tunnel.log 2>&1 &
          
          # 4. Wait for URL generation
          sleep 30
          
          # 5. Extract URL and Update Gist
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare\.com' tunnel.log | head -n 1)
          
          if [ -n "$TUNNEL_URL" ]; then
            echo "URL Found: $TUNNEL_URL"
            curl -X PATCH -H "Authorization: token $GH_PAT" \
                 -H "Content-Type: application/json" \
                 -d "{\"files\":{\"gistfile1.txt\":{\"content\":\"$TUNNEL_URL\"}}}" \
                 https://api.github.com/gists/$GIST_ID
          else
            echo "Cloudflare failed to provide a URL. Check tunnel.log:"
            cat tunnel.log
            exit 1
          fi
