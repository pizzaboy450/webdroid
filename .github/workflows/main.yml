name: Direct Browser Windows
on:
  workflow_dispatch:

jobs:
  windows-web:
    runs-on: windows-latest
    steps:
      - name: Setup Windows Desktop
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\ImmersiveShell" /v "TabletMode" /t REG_DWORD /d 1 /f

      - name: Create User
        run: |
          $password = "CloudPass2025!"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "CloudUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "CloudUser"
          echo "PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install & Start Web Bridge
        shell: pwsh
        run: |
          # Use Choco to get the Cloudflared binary without service conflicts
          choco install cloudflared -y
          
          # Start the tunnel for RDP port 3389
          # We redirect output to a file so we can grab the URL
          Start-Process powershell -ArgumentList "-NoProfile -Command & {cloudflared tunnel --url tcp://localhost:3389 > tunnel.log 2>&1}"
          
          Write-Host "Waking up the cloud..."
          Start-Sleep -Seconds 20

      - name: Show Browser Link
        shell: pwsh
        run: |
          $content = Get-Content tunnel.log
          $urlLine = $content | Select-String -Pattern "https://[a-z0-9-.]*trycloudflare.com"
          
          if ($urlLine) {
              $cleanURL = $urlLine.Matches.Value
              Write-Host "`n"
              Write-Host "********************************************************"
              Write-Host "âœ… WINDOWS IS ONLINE!"
              Write-Host "********************************************************"
              Write-Host "COPY THIS LINK -> $cleanURL"
              Write-Host "********************************************************"
              Write-Host "1. Go to https://remotedesktop.google.com/headless"
              Write-Host "   OR use any Web-RDP client (e.g. MyRDP.net)"
              Write-Host "2. Address: $cleanURL (remove the https:// part)"
              Write-Host "3. User: CloudUser | Pass: CloudPass2025!"
              Write-Host "********************************************************"
          } else {
              Write-Host "Full Log Output for Debugging:"
              Get-Content tunnel.log
              Write-Error "Tunnel failed to start."
          }

      - name: Stay Alive
        run: |
          while($true) { Start-Sleep -Seconds 300 }
