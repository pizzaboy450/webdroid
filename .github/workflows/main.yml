name: MuMu Web Touch
on:
  workflow_dispatch:
    inputs:
      ngrok_token:
        description: 'Your Ngrok Authtoken'
        required: true

jobs:
  mumu-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Install MuMu Player (Silent)
        run: |
          $url = "https://api.mumu.163.com/api/v1/download?product_id=1&channel=official"
          Invoke-WebRequest -Uri $url -OutFile "mumu_installer.exe"
          Start-Process ./mumu_installer.exe -ArgumentList "/S" -Wait
          Write-Host "MuMu Player Installed."

      - name: Install VNC Server & Ngrok
        run: |
          choco install tightvnc ngrok -y

      - name: Configure VNC for Web Access
        shell: powershell
        run: |
          # Set VNC password to 'mumu123' (Required for the service to start)
          $pass = "mumu123"
          & "C:\Program Files\TightVNC\tvnserver.exe" -install
          & "C:\Program Files\TightVNC\tvnserver.exe" -controlapp -setpassword $pass
          & "C:\Program Files\TightVNC\tvnserver.exe" -controlapp -setviewonlypassword $pass
          net start "TightVNC Server"

      - name: Start MuMu Player
        run: |
          # Start MuMu in the background
          Start-Process "C:\Program Files (x86)\MuMuPlayer-12.0\shell\MuMuPlayer.exe"
          Write-Host "MuMu is booting..."

      - name: Launch Web-VNC Bridge & Tunnel
        shell: powershell
        run: |
          # Add Ngrok Token
          ngrok config add-authtoken ${{ github.event.inputs.ngrok_token }}
          
          # Use Ngrok to tunnel the VNC port (5900)
          # We use 'http' mode with ngrok's built-in VNC-to-Web converter if available, 
          # or simply tunnel the TCP port for use with novnc.com
          Write-Host "URL will be available on your Ngrok Dashboard"
          Start-Process ngrok -ArgumentList "tcp 5900"
          
          # Keep the runner alive
          while ($true) {
              Write-Host "Cloud Android is Online... Use a VNC Web client to connect to the Ngrok TCP address."
              Start-Sleep -Seconds 300
          }
