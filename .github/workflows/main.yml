name: Windows GUI via Tmate
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Install Tmate and UltraVNC
        run: |
          choco install tmate ultravnc python -y
          python -m pip install websockify
          mkdir C:\noVNC
          git clone https://github.com/novnc/noVNC.git C:\noVNC

      - name: Start VNC Engine
        run: |
          $vncPath = "C:\Program Files\uvnc bvba\UltraVNC"
          # Password: password
          $regPath = "HKLM:\SOFTWARE\UltraVNC\Default"
          if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
          New-ItemProperty -Path $regPath -Name "Password" -Value ([byte[]](0x5E,0x2B,0xD3,0x64,0x90,0x6F,0x8F,0x00)) -PropertyType Binary -Force
          Start-Process -FilePath "$vncPath\winvnc.exe" -ArgumentList "-run" -NoNewWindow
          
          # Start the bridge to make VNC web-accessible locally
          Start-Process -FilePath "python.exe" -ArgumentList "-m websockify --web C:\noVNC 6080 localhost:5900" -NoNewWindow

      - name: Launch Tmate Tunnel
        shell: cmd
        run: |
          :: This starts tmate and saves the connection info to a file
          start /b tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait-for-session
          tmate -S /tmp/tmate.sock display -p "#{tmate_web}" > tmate_url.txt

      - name: Get Connection Links
        run: |
          $tmateUrl = Get-Content tmate_url.txt
          Write-Host "=========================================="
          Write-Host "STEP 1: OPEN THIS TERMINAL LINK:"
          Write-Host "$tmateUrl"
          Write-Host "=========================================="
          Write-Host "STEP 2: IN THAT TERMINAL, PASTE THIS:"
          Write-Host "curl -s localhost:6080"
          Write-Host "=========================================="

      - name: Keep Alive
        run: |
          Write-Host "Runner is active. If tmate disconnects, the job ends."
          Start-Sleep -Seconds 21600
