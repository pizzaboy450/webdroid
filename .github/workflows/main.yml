## Setup Guacamole Browser Access
name: Guacamole-Browser-RDP

on:
  workflow_dispatch:

jobs:
  guac-setup:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Configure Windows RDP
        run: |
          # Enable RDP and allow through firewall
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          
          # Set Password for runneradmin
          $password = "GuacPassword123!"
          $user = [adsi]"WinNT://localhost/runneradmin,user"
          $user.SetPassword($password)

      - name: Install Guacamole Bridge (Node.js)
        run: |
          # We use a combined bridge that provides the web UI and the tunnel
          npm install -g guacamole-lite
          
          # Create a small script to run the bridge
          $guacScript = @"
          const GuacamoleLite = require('guacamole-lite');
          const guacServer = new GuacamoleLite(
              { port: 8080 },
              { host: '127.0.0.1', port: 3389 },
              { encryption: 'none' }
          );
          "@
          $guacScript | Out-File -FilePath "guac-bridge.js"

      - name: Start Guacamole and Tunnel
        shell: pwsh
        run: |
          # 1. Start the bridge in the background
          Start-Process node -ArgumentList "guac-bridge.js" -NoNewWindow
          
          # 2. Install and Start Cloudflare Tunnel
          curl -L -o cloudflared.msi https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.msi
          Start-Process msiexec.exe -ArgumentList "/i", "cloudflared.msi", "/quiet", "/norestart" -Wait
          
          Write-Host "Starting Tunnel..."
          Start-Process -FilePath "C:\Program Files (x86)\cloudflared\cloudflared.exe" -ArgumentList "tunnel --url http://localhost:8080" -NoNewWindow -RedirectStandardError "tunnel.log"

      - name: Wait and Get Web Link
        run: |
          Write-Host "Warming up the browser interface..."
          Start-Sleep -Seconds 30
          
          $content = Get-Content "tunnel.log"
          $url = ($content | Select-String -Pattern "https://[a-zA-Z0-9.-]+").Matches.Value
          
          if ($url) {
              Write-Host "=========================================="
              Write-Host "GUACAMOLE BROWSER ACCESS READY"
              Write-Host "URL: $url"
              Write-Host "------------------------------------------"
              Write-Host "RDP User: runneradmin"
              Write-Host "RDP Password: GuacPassword123!"
              Write-Host "=========================================="
          } else {
              Get-Content "tunnel.log"
              throw "Tunnel failed."
          }

      - name: Keep Alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Browser session active..."
          }
