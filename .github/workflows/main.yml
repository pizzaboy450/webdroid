name: Fullscreen Browser Windows
on:
  workflow_dispatch:

jobs:
  windows-web:
    runs-on: windows-latest
    steps:
      - name: Configure Windows Desktop
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes

      - name: Install MeshCentral (Web Gateway)
        run: |
          npm install meshcentral
          # Start MeshCentral in the background
          Start-Process node -ArgumentList "node_modules/meshcentral" -WindowStyle Hidden

      - name: Start Tunnel
        shell: pwsh
        run: |
          choco install cloudflared -y
          # Tunnel the MeshCentral Web Port (80 or 443)
          Start-Process powershell -ArgumentList "-NoProfile -Command & {cloudflared tunnel --url http://localhost:80 > cf.log 2>&1}"
          Start-Sleep -Seconds 30

      - name: Get Your Direct Link
        shell: pwsh
        run: |
          $log = Get-Content cf.log
          $line = $log | Select-String -Pattern "https://[a-z0-9-.]*trycloudflare.com"
          if ($line) {
              Write-Host "`n********************************************************"
              Write-Host "âœ… CLICK THIS LINK -> $($line.Matches.Value)"
              Write-Host "********************************************************"
              Write-Host "1. Open the link."
              Write-Host "2. Click 'Desktop' in the sidebar."
              Write-Host "3. You are now controlling Windows in your browser."
              Write-Host "********************************************************"
          }
          while($true) { Start-Sleep -Seconds 300 }
