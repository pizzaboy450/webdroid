name: Guacamole-Ngrok-Final
on:
  workflow_dispatch:

jobs:
  setup-guac:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Configure Windows RDP
        run: |
          # Enable RDP and allow through firewall
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          
          # Set Password for runneradmin
          $password = "GuacPassword123!"
          $user = [adsi]"WinNT://localhost/runneradmin,user"
          $user.SetPassword($password)

      - name: Install Guacamole Bridge & Ngrok
        run: |
          # Install Node.js bridge and Ngrok
          npm install -g guacamole-lite
          choco install ngrok -y
          
          # Create the bridge script
          $guacScript = @"
          const GuacamoleLite = require('guacamole-lite');
          const guacServer = new GuacamoleLite(
              { port: 8080 },
              { host: '127.0.0.1', port: 3389 },
              { encryption: 'none' }
          );
          "@
          $guacScript | Out-File -FilePath "guac-bridge.js"

      - name: Start Services
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # 1. Start the Guacamole bridge
          Start-Process node -ArgumentList "guac-bridge.js" -NoNewWindow
          
          # 2. Start Ngrok HTTP tunnel
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process -FilePath "ngrok.exe" -ArgumentList "http 8080" -NoNewWindow

      - name: Get Public URL
        run: |
          Write-Host "Waiting for Ngrok to stabilize..."
          Start-Sleep -Seconds 15
          
          # Fetch the URL from Ngrok's local API
          $tunnels = curl.exe -s http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
          $url = $tunnels.tunnels[0].public_url
          
          if ($url) {
              Write-Host "=========================================="
              Write-Host "SUCCESS! NO MORE 1033 ERRORS."
              Write-Host "BROWSER LINK: $url"
              Write-Host "------------------------------------------"
              Write-Host "User: runneradmin"
              Write-Host "Pass: GuacPassword123!"
              Write-Host "=========================================="
          } else {
              throw "Ngrok failed to start. Check your NGROK_AUTH_TOKEN secret."
          }

      - name: Keep Alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active..."
          }
