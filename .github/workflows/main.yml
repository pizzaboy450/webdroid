name: AndroidCloudStream
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install ADB
        run: |
          sudo apt-get update
          sudo apt-get install -y adb

      - name: Launch Android Container
        run: |
          docker run -d -p 6080:80 -p 5555:5555 --name redroid --privileged redroid/redroid:11.0.0-latest
          echo "Waiting for Android to boot..."
          sleep 60

      - name: Start Cloudflare Tunnel
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GIST_ID: "a4b55baae4fc0ffc6f8b9e6ee7f12d75"
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          
          # Wait for the server to be ready locally
          timeout 60s bash -c 'until curl -s localhost:6080 > /dev/null; do sleep 2; done'
          
          ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate > tunnel.log 2>&1 &
          sleep 30
          
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo "URL: $TUNNEL_URL"
          
          if [ -n "$TUNNEL_URL" ]; then
            curl -X PATCH -H "Authorization: token $GH_PAT" \
                 -H "Content-Type: application/json" \
                 -d "{\"files\":{\"gistfile1.txt\":{\"content\":\"$TUNNEL_URL\"}}}" \
                 https://api.github.com/gists/$GIST_ID
          fi

      - name: Recursive Restart
        if: always()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          sleep 18900
          curl -X POST -H "Authorization: token $GH_PAT" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/actions/workflows/main.yml/dispatches \
               -d '{"ref":"main"}'
