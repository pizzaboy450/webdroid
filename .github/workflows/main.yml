name: Windows HD Stream Final
on: 
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream_desktop:
    runs-on: windows-latest
    permissions:
      contents: write # Needed to save the URL to the repo
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          choco install nginx --version 1.24.0 -y --skip-already-installed
          choco install obs-studio ffmpeg ngrok vb-cable -y --skip-already-installed
        shell: powershell

      - name: Start Nginx
        shell: powershell
        run: |
          # Create HLS directory
          if (!(Test-Path "C:\temp\hls")) { New-Item -ItemType Directory -Path "C:\temp\hls" -Force }
          # Move to Nginx folder and start
          cd C:\tools\nginx-1.24.0
          Start-Process .\nginx.exe
          
      - name: Start Ngrok & Save URL
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process ngrok -ArgumentList "http 80" -NoNewWindow
          Start-Sleep -Seconds 15
          $url = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels[0].public_url
          $streamUrl = "$url/hls/live.m3u8"
          Set-Content -Path "current_stream.txt" -Value $streamUrl
          
          # Push URL to repo so Extension can find it
          git config --global user.name "StreamBot"
          git config --global user.email "bot@github.com"
          git add current_stream.txt
          git commit -m "Update Stream URL [skip ci]"
          git push

      - name: Start OBS Studio
        shell: powershell
        run: |
          # Starts OBS in the background
          Start-Process "C:\Program Files\obs-studio\bin\64bit\obs64.exe" -ArgumentList "--startstreaming"

      - name: Run and Repeat
        shell: powershell
        run: |
          Write-Host "Streaming for 5 hours..."
          Start-Sleep -Seconds 18000
          
          # Trigger next run
          curl -X POST -H "Authorization: token ${{ secrets.MY_GITHUB_TOKEN }}" `
          -H "Accept: application/vnd.github.v3+json" `
          https://api.github.com/repos/${{ github.repository }}/dispatches `
          -d '{"event_type": "restart_stream"}'
