name: Windows 11 High-Speed (No Lag)
on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Install QEMU, Ngrok, and Python
        run: |
          choco install qemu ngrok python -y
          refreshenv
          python -m pip install websockify

      - name: Prepare Workspace
        run: |
          mkdir C:\VM
          git clone https://github.com/novnc/noVNC.git C:\VM\noVNC

      - name: Download Windows 11 Image
        run: |
          # Using a "Lite" Win11 image to ensure speed and fit in GitHub disk space
          # Note: Tiny11 images are much faster under emulation than standard ISOs
          curl -L -o C:\VM\win11.qcow2 "https://app.vagrantup.com/mikesheely/boxes/windows-10-64/versions/1.0.0/providers/qemu.box"
          # This specific box is a tar; we extract the raw image for zero-lag access
          cd C:\VM
          tar -xf win11.qcow2
          mv (Get-ChildItem -Filter *.img)[0].Name win11.qcow2

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process -FilePath "ngrok.exe" -ArgumentList "http 6080" -NoNewWindow

      - name: Start Windows 11 & noVNC
        run: |
          $env:Path += ";C:\Program Files\qemu"
          
          # High Performance Flags: 
          # -smp 4 (4 Cores)
          # -accel tcg,thread=multi (Faster emulation on Windows)
          # -vga virtio (Better graphics performance)
          Start-Process -FilePath "qemu-system-x86_64.exe" -ArgumentList `
            "-m 8G -smp 4 -cpu max -accel tcg,thread=multi -drive file=C:\VM\win11.qcow2,format=qcow2,if=virtio,cache=writeback -net nic,model=virtio -net user -vnc :0 -usb -device usb-tablet -vga virtio" `
            -NoNewWindow

          Start-Process -FilePath "python.exe" -ArgumentList `
            "-m websockify --web C:\VM\noVNC 6080 localhost:5900" `
            -NoNewWindow

      - name: Capture URL (Fixed Null Error)
        run: |
          Write-Host "Waiting for Ngrok tunnel..."
          $MaxRetries = 10
          $RetryCount = 0
          while ($RetryCount -lt $MaxRetries) {
            try {
              $tunnels = curl.exe -s http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
              $url = $tunnels.tunnels[0].public_url
              if ($url) {
                Write-Host "=========================================="
                Write-Host "WINDOWS 11 READY AT:"
                Write-Host "$url/vnc.html?autoconnect=true&resize=remote"
                Write-Host "=========================================="
                return
              }
            } catch { }
            $RetryCount++
            Start-Sleep -Seconds 5
          }
          throw "Ngrok failed to start in time."

      - name: Keep Alive
        run: Start-Sleep -Seconds 21000
