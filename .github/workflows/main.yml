name: Browser Windows (No Ngrok)
on:
  workflow_dispatch:

jobs:
  windows-direct:
    runs-on: windows-latest
    steps:
      - name: Setup Windows Environment
        run: |
          # Optimize for touch/tablet feel
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\ImmersiveShell" /v "TabletMode" /t REG_DWORD /d 1 /f
          # Set a standard password for the runneradmin user
          net user runneradmin CloudPass2025!

      - name: Install Cloudflared & RustDesk
        shell: pwsh
        run: |
          choco install cloudflared -y
          # Download RustDesk (The 'engine' that handles the video stream)
          Invoke-WebRequest -Uri "https://github.com/rustdesk/rustdesk/releases/download/1.2.3-2/rustdesk-1.2.3-2-x86_64.exe" -OutFile "rustdesk.exe"
          
          # Start RustDesk in the background
          Start-Process ./rustdesk.exe --silent-install
          Start-Sleep -Seconds 15

      - name: Launch Web Gateway
        shell: pwsh
        run: |
          # Use Cloudflare to create a DIRECT HTTP link to the RustDesk web server
          # RustDesk's local web server runs on 21118 or 8000 depending on version
          # We will tunnel the standard RDP-to-Web port
          Start-Process powershell -ArgumentList "-NoProfile -Command & {cloudflared tunnel --url http://localhost:8000 > cf.log 2>&1}"
          Write-Host "Generating your browser link..."
          Start-Sleep -Seconds 20

      - name: Final Browser Link
        shell: pwsh
        run: |
          $log = Get-Content cf.log
          $line = $log | Select-String -Pattern "https://[a-z0-9-.]*trycloudflare.com"
          
          if ($line) {
              $URL = $line.Matches.Value
              Write-Host "`n"
              Write-Host "========================================================"
              Write-Host "âœ… WINDOWS IS READY (NO NGROK)"
              Write-Host "========================================================"
              Write-Host "1. OPEN THIS URL: $URL"
              Write-Host "2. If prompted for a password: CloudPass2025!"
              Write-Host "========================================================"
          } else {
              Get-Content cf.log
              Write-Error "Failed to generate link."
          }

      - name: Stay Alive
        run: |
          while($true) { Start-Sleep -Seconds 300 }
