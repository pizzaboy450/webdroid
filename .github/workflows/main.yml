name: Android Cloud Stream
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install ADB
        run: |
          sudo apt-get update
          sudo apt-get install -y adb

      - name: Launch Android Container
        run: |
          # Start Redroid with higher privileges
          docker run -d -p 6080:80 -p 5555:5555 --name redroid --privileged redroid/redroid:11.0.0-latest
          echo "Waiting for Android to boot (60s)..."
          sleep 60

      - name: Connect ADB and Start Streamer
        run: |
          # Connect the local ADB to the running container
          adb connect localhost:5555
          sleep 5
          # Force the screen to stay on and unlock
          adb -s localhost:5555 shell wm dismiss-keyguard || echo "Screen already unlocked"
          # Ensure scrcpy is ready in the background
          docker exec -d redroid sh -c "scrcpy --always-on-top --initial-bit-rate=2M" || echo "Scrcpy start issued"
          sleep 5

      - name: Start Cloudflare Tunnel & Update Gist
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GIST_ID: "a4b55baae4fc0ffc6f8b9e6ee7f12d75"
        run: |
          # 1. Install Cloudflare Tunnel
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          
          # 2. Run tunnel in background
          ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate > tunnel.log 2>&1 &
          sleep 25
          
          # 3. Extract the URL
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo "Your URL is: $TUNNEL_URL"
          
          # 4. Update YOUR specific Gist file (gistfile1.txt)
          if [ -n "$TUNNEL_URL" ]; then
            curl -X PATCH -H "Authorization: token $GH_PAT" \
                 -H "Content-Type: application/json" \
                 -d "{\"files\":{\"gistfile1.txt\":{\"content\":\"$TUNNEL_URL\"}}}" \
                 https://api.github.com/gists/$GIST_ID
          else
            echo "Error: Tunnel URL not found in logs"
            exit 1
          fi

      - name: Recursive Keep-Alive
        if: always()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Sleep for 5 hours and 15 mins then trigger next run
          sleep 18900
          curl -X POST -H "Authorization: token $GH_PAT" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/actions/workflows/main.yml/dispatches \
               -d '{"ref":"main"}'
