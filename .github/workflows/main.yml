name: Redroid Fullscreen Web
on: 
  workflow_dispatch:
    inputs:
      ngrok_token:
        description: 'Ngrok Token'
        required: true

jobs:
  redroid:
    runs-on: ubuntu-latest
    steps:
      - name: Install Kernel Extras
        run: |
          sudo apt-get update
          sudo apt-get install -y linux-modules-extra-$(uname -r)
          sudo modprobe binder_linux devices="binder,hwbinder,vndbinder"

      - name: Start Redroid (The Phone)
        run: |
          docker run -d --privileged \
            --name redroid \
            -p 5555:5555 \
            redroid/redroid:11.0.0-latest \
            androidboot.redroid_width=1920 \
            androidboot.redroid_height=1080 \
            androidboot.redroid_dpi=480 \
            androidboot.use_memfd=true

      - name: Start Web Viewer (The Screen)
        run: |
          # This connects the web interface to the Redroid container
          docker run -d --name web-viewer \
            -p 6080:6080 \
            -e EMULATOR_IP=host.docker.internal \
            -e EMULATOR_PORT=5555 \
            --add-host=host.docker.internal:host-gateway \
            budtmo/docker-android:emulator_11.0

      - name: Tunnel with Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken ${{ github.event.inputs.ngrok_token }}
          ngrok http 6080 --log=stdout &
          sleep 3600
