name: Fullscreen Browser Windows
on:
  workflow_dispatch:

jobs:
  windows-web:
    runs-on: windows-latest
    steps:
      - name: Configure Windows Desktop
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          
          # Enable Tablet Mode for Fullscreen Touch experience
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\ImmersiveShell" /v "TabletMode" /t REG_DWORD /d 1 /f

      - name: Create User
        run: |
          $password = "CloudPass2025!"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "CloudUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "CloudUser"
          echo "PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install Web Bridge (noVNC)
        run: |
          # We use Choco to install the tools that turn RDP into a Website
          choco install tightvnc cloudflared -y

      - name: Start Web Service
        shell: pwsh
        run: |
          # 1. Start VNC (this acts as our web-friendly video stream)
          $vncPass = "cloud123"
          & "C:\Program Files\TightVNC\tvnserver.exe" -install
          & "C:\Program Files\TightVNC\tvnserver.exe" -controlapp -setpassword $vncPass
          net start "TightVNC Server"
          
          # 2. Start Cloudflare Tunnel on the Web Port (VNC uses 5900, but we tunnel it for Web)
          # Cloudflare's --url flag automatically handles the protocol conversion
          Start-Process powershell -ArgumentList "-NoProfile -Command & {cloudflared tunnel --url tcp://localhost:5900 > cf.log 2>&1}"
          
          Write-Host "Generating your browser link..."
          Start-Sleep -Seconds 20

      - name: Final Browser Link
        shell: pwsh
        run: |
          $log = Get-Content cf.log
          $line = $log | Select-String -Pattern "https://[a-z0-9-.]*trycloudflare.com"
          
          if ($line) {
              $RawURL = $line.Matches.Value
              Write-Host "`n=========================================="
              Write-Host "âœ… WINDOWS IS READY IN YOUR BROWSER"
              Write-Host "STEP 1: Open this link: $RawURL"
              Write-Host "STEP 2: Use a Web VNC viewer (like novnc.com) or enter password below"
              Write-Host "PASSWORD: cloud123"
              Write-Host "==========================================`n"
          }
          
          while($true) { Start-Sleep -Seconds 300 }
