name: Windows HD Desktop Stream
on: workflow_dispatch

jobs:
  stream_desktop:
    runs-on: windows-latest
    steps:
      - name: Install Chocolatey Packages
        run: |
          choco install nginx obs-studio ffmpeg ngrok -y --no-progress
        shell: powershell

      - name: Configure Nginx RTMP/HLS Server
        shell: powershell
        run: |
          $nginxConfPath = "C:\ProgramData\chocolatey\lib\nginx\tools\nginx.conf"
          if (!(Test-Path "C:\temp\hls")) { New-Item -ItemType Directory -Path "C:\temp\hls" -Force }
          $conf = @"
          worker_processes 1;
          events { worker_connections 1024; }
          rtmp {
              server {
                  listen 1935;
                  application live {
                      live on;
                      hls on;
                      hls_path C:/temp/hls;
                      hls_fragment 3s;
                      hls_playlist_length 10s;
                  }
              }
          }
          http {
              include mime.types;
              server {
                  listen 80;
                  location /hls {
                      root C:/temp;
                      add_header Access-Control-Allow-Origin *;
                      types {
                          application/vnd.apple.mpegurl m3u8;
                          video/mp2t ts;
                      }
                  }
              }
          }
          "@
          Set-Content -Path $nginxConfPath -Value $conf

      - name: Start Nginx
        run: |
          cd C:\ProgramData\chocolatey\lib\nginx\tools\
          Start-Process .\nginx.exe
        shell: powershell

      - name: Start Ngrok Tunnel
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process ngrok -ArgumentList "http 80" -NoNewWindow

      - name: Get Ngrok HLS URL
        shell: powershell
        id: ngrok_url_step
        run: |
          Start-Sleep -Seconds 15
          $tunnels = Invoke-RestMethod http://localhost:4040/api/tunnels
          $public_url = $tunnels.tunnels[0].public_url
          $full_hls_url = "${public_url}/hls/live.m3u8"
          Write-Host "----------------------------------------------------"
          Write-Host "HLS STREAM URL: $full_hls_url"
          Write-Host "----------------------------------------------------"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "HLS_URL=$full_hls_url"

      - name: Start OBS Studio
        shell: powershell
        run: |
          # Note: OBS requires a scene. In a headless environment, 
          # you may need to use 'obs-cli' or a pre-configured profile.
          # This command starts OBS and attempts to stream.
          Start-Process "C:\Program Files\obs-studio\bin\64bit\obs64.exe" -ArgumentList "--startstreaming", "--run-from-config"

      - name: Keep Alive (6 Hours)
        shell: powershell
        run: |
          $startTime = Get-Date
          $targetTime = $startTime.AddHours(6)
          while ((Get-Date) -lt $targetTime) {
            Write-Host "Runner active and streaming... $((Get-Date).ToString())"
            Start-Sleep -Seconds 60
          }
