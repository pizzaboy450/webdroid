name: RDP-noVNC (Direct Fix)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install noVNC and Dependencies
        run: |
          choco install ultravnc ngrok python -y
          python -m pip install websockify
          mkdir C:\noVNC
          git clone https://github.com/novnc/noVNC.git C:\noVNC

      - name: Start UltraVNC Server
        run: |
          $vncPath = "C:\Program Files\uvnc bvba\UltraVNC"
          stop-process -name winvnc -ErrorAction SilentlyContinue
          # Injected password: password
          $regPath = "HKLM:\SOFTWARE\UltraVNC\Default"
          if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
          New-ItemProperty -Path $regPath -Name "Password" -Value ([byte[]](0x5E,0x2B,0xD3,0x64,0x90,0x6F,0x8F,0x00)) -PropertyType Binary -Force
          Start-Process -FilePath "$vncPath\winvnc.exe" -ArgumentList "-run" -NoNewWindow

      - name: Start Ngrok (Forced Background)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # Use --accept-tos to prevent ngrok from hanging on the first run
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-ThreadJob { ngrok http 6080 --log=stdout }
          
      - name: Start Websockify Bridge
        run: |
          # Bridge local VNC (5900) to noVNC Web (6080)
          Start-Process -FilePath "python.exe" -ArgumentList "-m websockify --web C:\noVNC 6080 localhost:5900" -NoNewWindow

      - name: Get Public URL (Reliable Loop)
        run: |
          Write-Host "Searching for active tunnel..."
          for ($i=1; $i -le 30; $i++) {
            $tunnels = curl.exe -s http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
            if ($tunnels.tunnels.Count -gt 0) {
              $url = $tunnels.tunnels[0].public_url
              Write-Host "=========================================="
              Write-Host "ACCESS YOUR WINDOWS HERE:"
              Write-Host "$url/vnc.html?autoconnect=true"
              Write-Host "VNC Password: password"
              Write-Host "=========================================="
              return
            }
            Write-Host "Tunnel not ready... attempt $i/30"
            Start-Sleep -Seconds 3
          }
          throw "Ngrok failed to initialize."

      - name: Maintain Connection
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active..."
          }
