name: Ultimate Browser Windows
on:
  workflow_dispatch:

jobs:
  windows-direct:
    runs-on: windows-latest
    steps:
      - name: Kill Conflicting Services
        run: |
          Stop-Service -Name "tvnserver" -ErrorAction SilentlyContinue
          Stop-Process -Name "rustdesk" -ErrorAction SilentlyContinue

      - name: Install & Configure VNC
        run: |
          choco install tightvnc cloudflared -y
          $vncPass = "cloud123"
          & "C:\Program Files\TightVNC\tvnserver.exe" -install
          & "C:\Program Files\TightVNC\tvnserver.exe" -controlapp -setpassword $vncPass
          net start "TightVNC Server"

      - name: Start Web-to-VNC Bridge
        shell: pwsh
        run: |
          # Download a portable Node.js bridge to turn VNC into a Website
          npm install -g novnc
          # Start the bridge on port 8080 (VNC 5900 -> Web 8080)
          Start-Process powershell -ArgumentList "-NoProfile -Command & {novnc --vnc localhost:5900 --listen 8080}"
          Start-Sleep -Seconds 10

      - name: Launch Cloudflare Tunnel
        shell: pwsh
        run: |
          # Tunnel the WEB port (8080)
          Start-Process powershell -ArgumentList "-NoProfile -Command & {cloudflared tunnel --url http://localhost:8080 > cf.log 2>&1}"
          Write-Host "Generating your browser link..."
          Start-Sleep -Seconds 20

      - name: Get Your Direct Link
        shell: pwsh
        run: |
          $log = Get-Content cf.log
          $line = $log | Select-String -Pattern "https://[a-z0-9-.]*trycloudflare.com"
          
          if ($line) {
              $URL = $line.Matches.Value
              Write-Host "`n"
              Write-Host "********************************************************"
              Write-Host "âœ… WINDOWS BROWSER READY"
              Write-Host "********************************************************"
              Write-Host "LINK: $URL/vnc.html"
              Write-Host "PASSWORD: cloud123"
              Write-Host "********************************************************"
          } else {
              Get-Content cf.log
              Write-Error "Link generation failed."
          }

      - name: Keep Online
        run: |
          while($true) { Start-Sleep -Seconds 300 }
