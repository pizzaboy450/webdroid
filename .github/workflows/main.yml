name: RDP-noVNC-Localtunnel
on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install noVNC and Dependencies
        run: |
          choco install ultravnc python nodejs -y
          python -m pip install websockify
          npm install -g localtunnel
          mkdir C:\noVNC
          git clone https://github.com/novnc/noVNC.git C:\noVNC

      - name: Start UltraVNC (App Mode)
        run: |
          $vncPath = "C:\Program Files\uvnc bvba\UltraVNC"
          stop-process -name winvnc -ErrorAction SilentlyContinue
          $regPath = "HKLM:\SOFTWARE\UltraVNC\Default"
          if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
          # Set password to: password
          New-ItemProperty -Path $regPath -Name "Password" -Value ([byte[]](0x5E,0x2B,0xD3,0x64,0x90,0x6F,0x8F,0x00)) -PropertyType Binary -Force
          Start-Process -FilePath "$vncPath\winvnc.exe" -ArgumentList "-run" -NoNewWindow

      - name: Start Websockify Bridge
        run: |
          Start-Process -FilePath "python.exe" -ArgumentList "-m websockify --web C:\noVNC 6080 localhost:5900" -NoNewWindow

      - name: Launch Localtunnel
        run: |
          Write-Host "Starting Tunnel..."
          # Start localtunnel and save the output to find the URL
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c lt --port 6080 > lt_info.txt" -NoNewWindow
          
          Write-Host "Waiting for URL generation..."
          $url = $null
          for ($i=1; $i -le 20; $i++) {
              if (Test-Path "lt_info.txt") {
                  $content = Get-Content "lt_info.txt"
                  if ($content -like "https://*") {
                      $url = $content.Trim()
                      break
                  }
              }
              Start-Sleep -Seconds 3
          }

          if ($url) {
              Write-Host "=========================================="
              Write-Host "ACCESS YOUR WINDOWS HERE:"
              Write-Host "$url/vnc.html?autoconnect=true"
              Write-Host "VNC Password: password"
              Write-Host "=========================================="
          } else {
              throw "Localtunnel failed to start."
          }

      - name: Keep Alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active..."
          }
