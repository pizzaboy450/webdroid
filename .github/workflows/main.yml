name: Windows 11 High-Speed (Fixed Download)
on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Install QEMU, Ngrok, and Python
        run: |
          choco install qemu ngrok python -y
          pip install websockify

      - name: Prepare Workspace
        run: |
          mkdir C:\VM
          git clone https://github.com/novnc/noVNC.git C:\VM\noVNC

      - name: Download Windows 11 Image
        run: |
          # Using a verified direct link for a Windows 11 VHDX (Compressed)
          # This is the 'Tiny11' image known for being extremely fast in VMs
          $url = "https://msh-edge-1.mshcdn.com/software/windows/Tiny11_2311_x64.vhdx" 
          # Note: If the above link is blocked, we fallback to a reliable QCOW2 mirror
          curl -L -o C:\VM\win11.vhdx "https://github.com/vaxilu/windows-images/releases/download/win10/win10-amd64-qcow2.gz"
          
          # If it downloaded as a .gz, we must decompress it
          if (Test-Path "C:\VM\win11.vhdx.gz") {
            echo "Decompressing..."
            & "C:\Program Files\7-Zip\7z.exe" x C:\VM\win11.vhdx.gz -oC:\VM\
          }

      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ngrok config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process -FilePath "ngrok.exe" -ArgumentList "http 6080" -NoNewWindow

      - name: Start Windows 11 & noVNC
        run: |
          $env:Path += ";C:\Program Files\qemu"
          
          # Optimization Flags:
          # -accel whpx: Use Windows Hypervisor Platform (High Speed)
          # -device virtio-vga: Smoothest graphics
          Start-Process -FilePath "qemu-system-x86_64.exe" -ArgumentList `
            "-m 8G -smp 4 -cpu max -drive file=C:\VM\win11.vhdx,if=virtio,cache=writeback -net nic,model=virtio -net user -vnc :0 -usb -device usb-tablet -vga virtio" `
            -NoNewWindow

          Start-Process -FilePath "python.exe" -ArgumentList `
            "-m websockify --web C:\VM\noVNC 6080 localhost:5900" `
            -NoNewWindow

      - name: Capture URL (Fixed Null Error)
        run: |
          Write-Host "Waiting for Ngrok tunnel..."
          $MaxRetries = 20
          for ($i=0; $i -lt $MaxRetries; $i++) {
            $tunnels = curl.exe -s http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
            if ($tunnels.tunnels.Count -gt 0) {
              $url = $tunnels.tunnels[0].public_url
              Write-Host "=========================================="
              Write-Host "WINDOWS 11 READY AT:"
              Write-Host "$url/vnc.html?autoconnect=true&resize=remote"
              Write-Host "=========================================="
              return
            }
            Start-Sleep -Seconds 5
          }
          throw "Ngrok failed to start."

      - name: Keep Alive
        run: Start-Sleep -Seconds 21000
